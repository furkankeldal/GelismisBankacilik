name: Docker Compose Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  docker-compose-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Compose
      run: |
        docker compose version

    - name: Build Docker images
      run: |
        docker compose build

    - name: Start services
      run: |
        docker compose up -d
        docker compose ps

    - name: Wait for services to be healthy
      run: |
        set -euo pipefail
        # Note: `docker compose ps | grep healthy` is not sufficient because it
        # becomes true as soon as ANY container is healthy. We wait for each
        # HTTP endpoint instead (more reliable in CI).

        wait_url () {
          local url="$1"
          local attempts="${2:-60}"
          local sleep_s="${3:-5}"

          echo "Waiting for $url"
          for i in $(seq 1 "$attempts"); do
            if curl -fsS --max-time 5 "$url" >/dev/null; then
              echo "OK: $url"
              return 0
            fi
            echo "Not ready ($i/$attempts): $url"
            sleep "$sleep_s"
          done

          echo "FAILED waiting for $url"
          return 1
        }

        # Infra
        wait_url "http://localhost:8888/actuator/health" 60 5
        wait_url "http://localhost:8761/actuator/health" 60 5
        # Gateway
        wait_url "http://localhost:8095/actuator/health" 60 5
        # Microservices health via API Gateway discovery routes
        wait_url "http://localhost:8095/customer-service/actuator/health" 60 5
        wait_url "http://localhost:8095/account-service/actuator/health" 60 5
        wait_url "http://localhost:8095/process-service/actuator/health" 60 5

        docker compose ps

    - name: Check service health (only via gateway + infra)
      run: |
        set -euo pipefail
        curl -fsS --retry 10 --retry-all-errors --retry-delay 2 --max-time 10 http://localhost:8761/actuator/health
        curl -fsS --retry 10 --retry-all-errors --retry-delay 2 --max-time 10 http://localhost:8888/actuator/health
        curl -fsS --retry 10 --retry-all-errors --retry-delay 2 --max-time 10 http://localhost:8095/actuator/health
        curl -fsS --retry 10 --retry-all-errors --retry-delay 2 --max-time 10 http://localhost:8095/customer-service/actuator/health
        curl -fsS --retry 10 --retry-all-errors --retry-delay 2 --max-time 10 http://localhost:8095/account-service/actuator/health
        curl -fsS --retry 10 --retry-all-errors --retry-delay 2 --max-time 10 http://localhost:8095/process-service/actuator/health

    - name: View logs on failure
      if: failure()
      run: |
        docker compose logs --tail=100

    - name: Stop services
      if: always()
      run: |
        docker compose down -v

